apiVersion: batch/v1
kind: CronJob
metadata:
  name: 'lab-cleanup-cronjob'
  namespace: devsarena
spec:
  schedule: "0 * * * *"  # Will be overridden by environment variable in orchestrator
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: cleanup-inactive-labs
            image: alpine:latest
            env:
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: aws-secrets
                  key: REDIS_URI
            - name: CLEANUP_API_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: lab-cleanup-config
                  key: CLEANUP_API_ENDPOINT
            - name: CRONITOR_MONITOR_URL
              valueFrom:
                configMapKeyRef:
                  name: lab-cleanup-config
                  key: CRONITOR_MONITOR_URL
            - name: CRONITOR_MONITOR_KEY
              valueFrom:
                configMapKeyRef:
                  name: lab-cleanup-config
                  key: CRONITOR_MONITOR_KEY
            - name: INACTIVE_THRESHOLD
              valueFrom:
                configMapKeyRef:
                  name: lab-cleanup-config
                  key: INACTIVE_THRESHOLD
            command:
            - sh
            - -c
            - |
              apk add --no-cache curl redis jq ca-certificates

              MONITOR_KEY="${CRONITOR_MONITOR_KEY}"
              MONITOR_BASE_URL="${CRONITOR_MONITOR_URL}"
              MONITOR_URL="${MONITOR_BASE_URL}/${MONITOR_KEY}"
              API_ENDPOINT="${CLEANUP_API_ENDPOINT}"
              INACTIVE_THRESHOLD="${INACTIVE_THRESHOLD:-1800}"

              echo "$(date): Starting cleanup of inactive labs"
              echo "$(date): MONITOR_KEY: $MONITOR_KEY"
              echo "$(date): MONITOR_BASE_URL: $MONITOR_BASE_URL"
              echo "$(date): Monitor URL: $MONITOR_URL"
              echo "$(date): Configuration:"
              echo "$(date):   - API Endpoint: $API_ENDPOINT"
              echo "$(date):   - Monitor URL: $MONITOR_URL"
              echo "$(date):   - Inactive Threshold: $INACTIVE_THRESHOLD seconds"

              # Send cronitor ping to indicate job started
              echo "$(date): Sending start notification to Cronitor..."
              START_MSG="Starting cleanup of inactive labs"
              START_URL="$MONITOR_URL?state=run&msg=$(echo "$START_MSG" | sed 's/ /%20/g')"
              echo "$(date): Start URL: $START_URL"
              START_RESPONSE=$(curl -v -k -s -w "HTTPSTATUS:%{http_code}" --connect-timeout 10 --max-time 30 "$START_URL" 2>&1 || echo "curl_failed")
              echo "$(date): Raw curl response: $START_RESPONSE"
              if echo "$START_RESPONSE" | grep -q "HTTPSTATUS:200"; then
                echo "$(date): Successfully sent start notification to Cronitor"
              else
                echo "$(date): Failed to send start notification to Cronitor (Response: $START_RESPONSE)"
              fi

              CURRENT_TIME=$(date +%s)
              CLEANUP_COUNT=0

              echo "$(date): Current time: $CURRENT_TIME"
              echo "$(date): Inactive threshold: $INACTIVE_THRESHOLD seconds"

              # Get all items from the labs_monitor queue
              MONITOR_ITEMS=$(redis-cli -u $REDIS_URL LRANGE "labs_monitor" 0 -1)

              if [ -z "$MONITOR_ITEMS" ]; then
                echo "$(date): No labs found in monitor queue"
                # Send cronitor ping for completion
                echo "$(date): Sending completion notification to Cronitor..."
                COMPLETE_MSG="No labs to cleanup"
                COMPLETE_URL="$MONITOR_URL?state=complete&msg=$(echo "$COMPLETE_MSG" | sed 's/ /%20/g')"
                echo "$(date): Complete URL: $COMPLETE_URL"
                COMPLETE_RESPONSE=$(curl -v -k -s -w "HTTPSTATUS:%{http_code}" --connect-timeout 10 --max-time 30 "$COMPLETE_URL" 2>&1 || echo "curl_failed")
                echo "$(date): Raw curl response: $COMPLETE_RESPONSE"
                if echo "$COMPLETE_RESPONSE" | grep -q "HTTPSTATUS:200"; then
                  echo "$(date): Successfully sent completion notification to Cronitor"
                else
                  echo "$(date): Failed to send completion notification to Cronitor (Response: $COMPLETE_RESPONSE)"
                fi
                exit 0
              fi

              # Process labs and count cleanups
              CLEANUP_COUNT=0
              TEMP_FILE=$(mktemp /tmp/lab_cleanup_XXXXXX 2>/dev/null || echo "/tmp/lab_cleanup_$$")

              # Initialize temp file
              : > "$TEMP_FILE" 2>/dev/null && echo "$(date): Using temp file: $TEMP_FILE" || TEMP_FILE=""

              while IFS= read -r item; do
                if [ -z "$item" ]; then
                  continue
                fi

                LAB_ID=$(echo "$item" | jq -r '.labID // .LabID // empty' 2>/dev/null || echo "")
                LAST_UPDATED=$(echo "$item" | jq -r '.LastUpdatedAt // .lastUpdatedAt // empty' 2>/dev/null || echo "")
                STATUS=$(echo "$item" | jq -r '.status // .Status // empty' 2>/dev/null || echo "")

                echo "$(date): Processing entry - LabID: '$LAB_ID', LastUpdated: '$LAST_UPDATED', Status: '$STATUS'"

                if [ -z "$LAB_ID" ] || [ -z "$LAST_UPDATED" ] || [ "$LAST_UPDATED" = "null" ]; then
                  echo "$(date): Skipping invalid entry - missing LabID, LastUpdated, or null timestamp"
                  continue
                fi

                TIME_DIFF=$((CURRENT_TIME - LAST_UPDATED))

                if [ $TIME_DIFF -gt $INACTIVE_THRESHOLD ]; then
                  echo "$(date): Lab $LAB_ID inactive for ${TIME_DIFF}s (> $INACTIVE_THRESHOLD), cleaning up"

                  LAB_DATA=$(redis-cli -u $REDIS_URL HGET "lab_instances" "$LAB_ID")
                  LAB_LANGUAGE=$(echo "$LAB_DATA" | jq -r '.Language // "javascript"' 2>/dev/null || echo "javascript")

                  if [ -z "$LAB_LANGUAGE" ] || [ "$LAB_LANGUAGE" = "null" ]; then
                    echo "$(date): Skipping $LAB_ID - missing language"
                    continue
                  fi

                  CLEANUP_RESPONSE=$(curl -s -X DELETE "$API_ENDPOINT" \
                    -H "Content-Type: application/json" \
                    -d "{\"language\": \"$LAB_LANGUAGE\", \"labId\": \"$LAB_ID\"}" || echo "failed")

                  if echo "$CLEANUP_RESPONSE" | grep -q "success\|ok\|deleted\|true"; then
                    echo "$(date): Successfully cleaned up lab $LAB_ID"

                    # Track cleanup count
                    if [ -n "$TEMP_FILE" ] && [ -f "$TEMP_FILE" ]; then
                      echo "1" >> "$TEMP_FILE"
                    else
                      CLEANUP_COUNT=$((CLEANUP_COUNT + 1))
                    fi

                    # Remove from Redis
                    redis-cli -u $REDIS_URL LREM "labs_monitor" 1 "$item" >/dev/null
                    redis-cli -u $REDIS_URL HDEL "lab_instances" "$LAB_ID" >/dev/null
                  else
                    echo "$(date): Failed to cleanup lab $LAB_ID"
                  fi
                else
                  echo "$(date): Lab $LAB_ID still active (${TIME_DIFF}s < $INACTIVE_THRESHOLD)"
                fi
              done < <(echo "$MONITOR_ITEMS")

              # Get final count
              if [ -n "$TEMP_FILE" ] && [ -f "$TEMP_FILE" ]; then
                CLEANUP_COUNT=$(wc -l < "$TEMP_FILE" 2>/dev/null || echo "$CLEANUP_COUNT")
                rm -f "$TEMP_FILE" 2>/dev/null
              fi

              echo "$(date): Cleanup completed. Processed $CLEANUP_COUNT inactive labs"

              # Send cronitor ping for completion
              if [ $CLEANUP_COUNT -gt 0 ]; then
                echo "$(date): Sending completion notification to Cronitor..."
                FINAL_MSG="Cleaned up $CLEANUP_COUNT inactive labs"
                FINAL_URL="$MONITOR_URL?state=complete&msg=$(echo "$FINAL_MSG" | sed 's/ /%20/g')"
                echo "$(date): Final URL: $FINAL_URL"
                FINAL_RESPONSE=$(curl -v -k -s -w "HTTPSTATUS:%{http_code}" --connect-timeout 10 --max-time 30 "$FINAL_URL" 2>&1 || echo "curl_failed")
                echo "$(date): Raw curl response: $FINAL_RESPONSE"
                if echo "$FINAL_RESPONSE" | grep -q "HTTPSTATUS:200"; then
                  echo "$(date): Successfully sent completion notification to Cronitor"
                else
                  echo "$(date): Failed to send completion notification to Cronitor (Response: $FINAL_RESPONSE)"
                fi
              else
                echo "$(date): Sending completion notification to Cronitor..."
                FINAL_MSG="No inactive labs found"
                FINAL_URL="$MONITOR_URL?state=complete&msg=$(echo "$FINAL_MSG" | sed 's/ /%20/g')"
                echo "$(date): Final URL: $FINAL_URL"
                FINAL_RESPONSE=$(curl -v -k -s -w "HTTPSTATUS:%{http_code}" --connect-timeout 10 --max-time 30 "$FINAL_URL" 2>&1 || echo "curl_failed")
                echo "$(date): Raw curl response: $FINAL_RESPONSE"
                if echo "$FINAL_RESPONSE" | grep -q "HTTPSTATUS:200"; then
                  echo "$(date): Successfully sent completion notification to Cronitor"
                else
                  echo "$(date): Failed to send completion notification to Cronitor (Response: $FINAL_RESPONSE)"
                fi
              fi
          restartPolicy: OnFailure
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
